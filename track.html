<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تفاصيل الطلب</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-image: radial-gradient(circle at center, #1a0505 0%, #000 100%); }
        .status-page-box { background: rgba(20, 20, 20, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 40px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); max-width: 550px; margin: 60px auto; position: relative; overflow: hidden; }
        .status-page-box::before { content: ''; position: absolute; top:0; left:0; width:100%; height:6px; background: linear-gradient(90deg, var(--primary), #ff4f58); }
        .account-card { background: #000; border: 1px solid #333; border-radius: 16px; padding: 25px; margin: 25px 0; text-align: center; }
        .profile-avatar { width: 100px; height: 100px; border-radius: 12px; object-fit: cover; border: 3px solid var(--primary); box-shadow: 0 0 20px rgba(229,9,20,0.4); margin-bottom: 15px; }
        .info-row { display: flex; justify-content: space-between; align-items: center; background: #111; padding: 12px 15px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #222; }
        .info-label { color: #888; font-size: 0.9rem; }
        .info-value { color: #fff; font-weight: bold; font-family: sans-serif; letter-spacing: 0.5px; direction: ltr; }
        .copy-btn { background:none; border:none; color:#555; cursor:pointer; font-size:1rem; }
        .product-description-box { margin-top: 30px; padding: 20px; background: #111; border-radius: 12px; border: 1px solid #222; text-align: right; }
        .product-description-box h4 { color: var(--primary); margin-bottom: 10px; }
        .product-description-box p { color: #ccc; line-height: 1.7; font-size: 0.95rem; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="notification-container"></div>
    <header><a href="index.html" class="logo">NETFLIX</a></header>
    <div class="container">
        <div class="status-page-box">
            <!-- Both views are hidden initially, script will show the correct one -->
            <div id="pending-view" style="display:none;">
                <div style="text-align: center;">
                    <div class="loader" style="width: 50px; height: 50px; margin-bottom: 20px;"></div>
                    <h2 style="font-size: 1.8rem;">جاري مراجعة الطلب</h2>
                    <p style="color: #888;">سيتم تحديث الصفحة تلقائياً... (<span id="disp-id-pending"></span>)</p>
                </div>
            </div>
            <div id="approved-view" style="display:none;">
                <div style="text-align: center;">
                    <i class="fas fa-check-circle" style="color:var(--success);font-size:3rem;margin-bottom:10px;"></i>
                    <h2 style="color: #fff;">طلبك جاهز! استمتع بالمشاهدة</h2>
                </div>
                <div id="account-display" class="account-card"></div>
                <div id="product-description-container"></div>
                <a href="index.html" style="display:block; text-align:center; color:#666; margin-top:20px;">العودة للمتجر</a>
            </div>
            <div id="error-view" style="display:none; text-align:center;">
                 <i class="fas fa-exclamation-triangle" style="color:var(--warning);font-size:3rem;margin-bottom:10px;"></i>
                 <h2 style="color: #fff;">حدث خطأ</h2>
                 <p style="color:#aaa;" id="error-message-text"></p>
                 <a href="index.html" class="btn" style="width:auto; margin-top:30px;">العودة للمتجر</a>
            </div>
        </div>
    </div>
    
    <!-- We will write the script directly here for simplicity and to ensure it runs correctly -->
    <script>
        // Use the same SERVER_URL from your main script.js
        const SERVER_URL = "https://hhjk-shop-final-v2.loca.lt"; 

        const pendingView = document.getElementById('pending-view');
        const approvedView = document.getElementById('approved-view');
        const errorView = document.getElementById('error-view');
        const accountDisplay = document.getElementById('account-display');
        const descriptionContainer = document.getElementById('product-description-container');
        const errorText = document.getElementById('error-message-text');

        let trackInterval;

        function renderApprovedData(data) {
            approvedView.style.display = 'block';
            pendingView.style.display = 'none';
            errorView.style.display = 'none';

            if (data.productDescription) {
                descriptionContainer.innerHTML = `<div class="product-description-box"><h4><i class="fas fa-info-circle"></i> تفاصيل إضافية</h4><p>${data.productDescription}</p></div>`;
            }

            if (data.profileName) { // It's a profile
                const imgSrc = data.profileImage ? `${SERVER_URL}${data.profileImage}` : 'https://upload.wikimedia.org/wikipedia/commons/0/0b/Netflix-avatar.png';
                accountDisplay.innerHTML = `
                    <img src="${imgSrc}" class="profile-avatar" alt="Profile Avatar">
                    <div class="info-row"><span class="info-label">اسم البروفايل</span><span class="info-value">${data.profileName}</span></div>
                    <div class="info-row"><span class="info-label">الرمز (PIN)</span><span class="info-value">${data.profilePin}</span></div>
                `;
            } else { // It's a full account
                accountDisplay.innerHTML = `
                    <div class="info-row"><span class="info-label">الإيميل</span><span class="info-value">${data.accountEmail} <button class="copy-btn" onclick="navigator.clipboard.writeText('${data.accountEmail}')"><i class="fas fa-copy"></i></button></span></div>
                    <div class="info-row"><span class="info-label">كلمة المرور</span><span class="info-value">${data.accountPassword} <button class="copy-btn" onclick="navigator.clipboard.writeText('${data.accountPassword}')"><i class="fas fa-copy"></i></button></span></div>
                `;
            }
        }

        async function checkStatus() {
            const id = new URLSearchParams(window.location.search).get('id');
            if (!id) {
                errorText.textContent = 'رقم الطلب غير موجود في الرابط.';
                errorView.style.display = 'block';
                return;
            }

            try {
                const res = await fetch(`${SERVER_URL}/order-status/${id}`);
                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.message || 'فشل في جلب حالة الطلب.');
                }

                if (data.status === 'approved' || data.status === 'completed') {
                    clearInterval(trackInterval); // Stop polling
                    renderApprovedData(data);
                } else if (data.status === 'pending') {
                    // Show pending view only if it's not already visible
                    if (pendingView.style.display !== 'block') {
                        document.getElementById('disp-id-pending').textContent = `#${id}`;
                        pendingView.style.display = 'block';
                    }
                    // If the interval is not already running, start it
                    if (!trackInterval) {
                        trackInterval = setInterval(checkStatus, 5000);
                    }
                } else {
                     throw new Error('حالة الطلب غير معروفة.');
                }

            } catch (error) {
                console.error('[Track] Error fetching status:', error);
                clearInterval(trackInterval);
                errorText.textContent = error.message;
                errorView.style.display = 'block';
                pendingView.style.display = 'none';
                approvedView.style.display = 'none';
            }
        };

        // Run the check as soon as the page loads
        document.addEventListener('DOMContentLoaded', checkStatus);

    </script>
</body>
</html>
